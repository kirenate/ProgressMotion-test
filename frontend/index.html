<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Store</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top">
                <h1>Book Store</h1>
                <div class="auth-buttons">
                    <span id="userInfo" style="display: none;"></span>
                    <a href="login.html" id="loginLink" class="auth-link-btn">Login</a>
                    <a href="register.html" id="registerLink" class="auth-link-btn">Register</a>
                    <button id="logoutBtn" class="auth-link-btn" style="display: none;">Logout</button>
                </div>
            </div>
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="Search books...">
                <button id="searchBtn">Search</button>
                <button id="clearSearchBtn">Clear</button>
            </div>
        </header>

        <div class="main-content">
            <aside class="sidebar">
                <h2>Categories</h2>
                <ul id="categoryList">
                    <li><a href="#" class="category-link" data-category="all">All Books</a></li>
                </ul>
            </aside>

            <main class="books-section">
                <div id="loading" class="loading">Loading...</div>
                <div id="error" class="error" style="display: none;"></div>
                <div id="booksGrid" class="books-grid"></div>
                <div id="pagination" class="pagination"></div>
            </main>
        </div>
    </div>

    <script src="auth.js"></script>
    <script>
        const API_BASE = 'http://localhost:8080/api';
        const PAGE_SIZE = 10;
        
        let currentPage = 0;
        let currentCategory = 'all';
        let currentSearch = '';
        let categories = [];

        async function fetchCategories() {
            try {
                const response = await fetch(`${API_BASE}/categories`);
                if (!response.ok) throw new Error('Failed to fetch categories');
                const data = await response.json();
                categories = data.categories || [];
                renderCategories();
            } catch (error) {
                console.error('Error fetching categories:', error);
            }
        }

        function renderCategories() {
            const categoryList = document.getElementById('categoryList');
            categoryList.innerHTML = '<li><a href="#" class="category-link active" data-category="all">All Books</a></li>';
            
            categories.forEach(category => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = '#';
                a.className = 'category-link';
                a.textContent = category.name;
                a.dataset.category = category.name;
                a.addEventListener('click', (e) => {
                    e.preventDefault();
                    selectCategory(category.name);
                });
                li.appendChild(a);
                categoryList.appendChild(li);
            });
        }

        function selectCategory(categoryName) {
            currentCategory = categoryName;
            currentSearch = '';
            currentPage = 0;
            document.getElementById('searchInput').value = '';
            
            document.querySelectorAll('.category-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[data-category="${categoryName}"]`).classList.add('active');
            
            loadBooks();
        }

        async function loadBooks() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const booksGrid = document.getElementById('booksGrid');
            const pagination = document.getElementById('pagination');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            booksGrid.innerHTML = '';
            pagination.innerHTML = '';

            try {
                let url;
                if (currentSearch) {
                    url = `${API_BASE}/books/search/${encodeURIComponent(currentSearch)}?page=${currentPage}&pageSize=${PAGE_SIZE}&sortBy=name&orderBy=DESC`;
                } else if (currentCategory === 'all') {
                    url = `${API_BASE}/books?page=${currentPage}&pageSize=${PAGE_SIZE}&sortBy=name&orderBy=DESC`;
                } else {
                    url = `${API_BASE}/books/${encodeURIComponent(currentCategory)}?page=${currentPage}&pageSize=${PAGE_SIZE}&sortBy=name&orderBy=DESC`;
                }

                const response = await fetch(url);
                if (!response.ok) {
                    if (response.status === 404) {
                        booksGrid.innerHTML = '<p class="no-books">No books found.</p>';
                        loading.style.display = 'none';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const books = data.books || [];
                
                loading.style.display = 'none';
                
                if (books.length === 0) {
                    booksGrid.innerHTML = '<p class="no-books">No books found.</p>';
                    return;
                }

                renderBooks(books);
                renderPagination(books.length === PAGE_SIZE);
            } catch (error) {
                loading.style.display = 'none';
                error.textContent = `Error: ${error.message}`;
                error.style.display = 'block';
                console.error('Error loading books:', error);
            }
        }

        function renderBooks(books) {
            const booksGrid = document.getElementById('booksGrid');
            booksGrid.innerHTML = '';

            books.forEach(book => {
                const bookCard = document.createElement('div');
                bookCard.className = 'book-card';
                
                const authors = Array.isArray(book.authors) ? book.authors.join(', ') : '';
                
                bookCard.innerHTML = `
                    <h3 class="book-title">${escapeHtml(book.name)}</h3>
                    ${authors ? `<p class="book-authors">${escapeHtml(authors)}</p>` : ''}
                    <p class="book-price">$${(book.price / 100).toFixed(2)}</p>
                    ${book.desc ? `<p class="book-desc">${escapeHtml(book.desc.substring(0, 150))}${book.desc.length > 150 ? '...' : ''}</p>` : ''}
                `;
                
                booksGrid.appendChild(bookCard);
            });
        }

        function renderPagination(hasMore) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            if (currentPage > 0) {
                const prevBtn = document.createElement('button');
                prevBtn.textContent = 'Previous';
                prevBtn.className = 'pagination-btn';
                prevBtn.addEventListener('click', () => {
                    currentPage--;
                    loadBooks();
                });
                pagination.appendChild(prevBtn);
            }

            const pageInfo = document.createElement('span');
            pageInfo.textContent = `Page ${currentPage + 1}`;
            pageInfo.className = 'page-info';
            pagination.appendChild(pageInfo);

            if (hasMore) {
                const nextBtn = document.createElement('button');
                nextBtn.textContent = 'Next';
                nextBtn.className = 'pagination-btn';
                nextBtn.addEventListener('click', () => {
                    currentPage++;
                    loadBooks();
                });
                pagination.appendChild(nextBtn);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        document.getElementById('searchBtn').addEventListener('click', () => {
            const searchTerm = document.getElementById('searchInput').value.trim();
            if (searchTerm) {
                currentSearch = searchTerm;
                currentCategory = 'all';
                currentPage = 0;
                
                document.querySelectorAll('.category-link').forEach(link => {
                    link.classList.remove('active');
                });
                document.querySelector('[data-category="all"]').classList.add('active');
                
                loadBooks();
            }
        });

        document.getElementById('clearSearchBtn').addEventListener('click', () => {
            document.getElementById('searchInput').value = '';
            currentSearch = '';
            currentPage = 0;
            loadBooks();
        });

        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('searchBtn').click();
            }
        });

        document.querySelector('[data-category="all"]').addEventListener('click', (e) => {
            e.preventDefault();
            selectCategory('all');
        });

        function updateAuthUI() {
            const isAuth = isAuthenticated();
            const loginLink = document.getElementById('loginLink');
            const registerLink = document.getElementById('registerLink');
            const logoutBtn = document.getElementById('logoutBtn');
            const userInfo = document.getElementById('userInfo');

            if (isAuth) {
                loginLink.style.display = 'none';
                registerLink.style.display = 'none';
                logoutBtn.style.display = 'inline-block';
                
                try {
                    const token = getToken();
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    if (payload.username) {
                        userInfo.textContent = `Welcome, ${payload.username}`;
                        userInfo.style.display = 'inline-block';
                    }
                } catch (e) {
                    console.error('Error parsing token:', e);
                }
            } else {
                loginLink.style.display = 'inline-block';
                registerLink.style.display = 'inline-block';
                logoutBtn.style.display = 'none';
                userInfo.style.display = 'none';
            }
        }

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await logout();
            updateAuthUI();
        });

        updateAuthUI();
        fetchCategories();
        loadBooks();
    </script>
</body>
</html>

